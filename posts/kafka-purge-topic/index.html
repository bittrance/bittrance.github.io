<!doctype html><html class=no-js lang><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no,maximum-scale=1"><title>Truncating a Kafka topic - Bittrance blog</title><meta name=keywords content><meta name=description content><link rel=stylesheet href=/css/highlight.min.css><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/diello.css><link rel=stylesheet href=/css/main.css></head><body><!--[if lte IE 9]><p class=browserupgrade>You are using an <strong>outdated</strong> browser. Please <a href=https://browsehappy.com/>upgrade your browser</a> to improve your experience and security.</p><![endif]--><div class=flex-column><div class=ads></div><div class=home><div class=logo><h1><a href=/>Bittrance blog</a></h1></div><div class=navigation><a href=/>HOME</a>
<a href=javascript:void(0); class=current>ARTICLE</a></div><div><article><h3>Truncating a Kafka topic</h3><div class=less><time>Published: Friday, Apr 2, 2021</time>&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;3 minute read&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;Using 480 words</div><div class=em><p>Sometimes, you want to get rid of messages from a Kafka topic. Perhaps you have consumers that always start from the beginning, or you realize the whole topic is full of messages with sensitive data that must not reach consumers.</p><p>In theory, you can easily delete a Kafka topic. However, this is quite disruptive and is likely to fail both producers and consumers on this topic even if you quickly recreate the topic. There is no telling what consumer groups tracking their own offsets or having custom rebalancing logic might do.</p><p>Instead, the best way to truncate a Kafka topic is to temporarily set that topic&rsquo;s retention time (<code>rentention.ms</code> config variable) to a low value and let Kafka purge all messages in the topic. This will not affect a running consumer group, so long as the retention time is higher than its time lag plus its processing time. Newly arriving consumer groups will see only messages that arrive after the truncate.</p><p>Messages are deleted from the topic by the <strong>log cleaner</strong>. It wakes up every <code>log.retention.check.interval.ms</code> (which defaults to 5 minutes) and looks through the topics to see what needs to be cleaned up. This operation is performed independently by each cluster member, each of which maintains its own log cleaner, so messages will disappear from some partitions earlier than others.</p><p>The retention time can be changed runtime (as of Kafka 2.4, <code>kafka-config.sh</code> is one of those commands that still require Zookeeper access):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ kafka-configs.sh --zookeeper zookeeper:2181 --alter <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --entity-type topics <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --entity-name some-topic <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --add-config retention.ms<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span>
</code></pre></div><p>Since the log cleaner runs periodically, you have to wait for a bit before data is actually deleted. When it runs, you will see the following in the log:</p><pre><code>[2021-03-31 19:43:15,739] INFO [Log partition=some-topic-0, dir=/kafka/kafka-logs-906aad843b03] Rolled new log segment at offset 216 in 3 ms. (kafka.log.Log)
[2021-03-31 19:43:15,739] INFO [Log partition=some-topic-0, dir=/kafka/kafka-logs-906aad843b03] Scheduling log segment [baseOffset 200, size 1552] for deletion. (kafka.log.Log)
[2021-03-31 19:43:15,740] INFO [Log partition=some-topic-0, dir=/kafka/kafka-logs-906aad843b03] Incrementing log start offset to 216 (kafka.log.Log)
[2021-03-31 19:44:15,740] INFO [Log partition=testo-0, dir=/kafka/kafka-logs-906aad843b03] Deleting segment 200 (kafka.log.Log)
</code></pre><p>So what value should you pick for <code>retention.ms</code>? You can of course set it to 1 ms, but keep in mind that a consumer typically has a window between poll operations in which it processes messages that it got from the latest poll. If the log cleaner deletes messages that arrived after consumer&rsquo;s latest poll, data loss may occur. In the best of worlds, you have metrics on your consumer processing time and can estimate a good temporary retention time.</p><p>Once all partitions have been truncated, you can remove (or reset) the topic retention time. Since there is a small risk of data loss during subsequent wakeups of the log cleaner, you should switch back as soon as possible after the log cleaner has run.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kafka-configs.sh --zookeeper zookeeper:2181 --alter <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --entity-type topics <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --entity-name some-topic <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --delete-config retention.ms
</code></pre></div></div><br><br><div class=less>Page link: <a href=/posts/kafka-purge-topic/ class=pagelink>/posts/kafka-purge-topic/</a></div><div class=line-dotted></div><article></div><footer><div>&#169; 2019 by <a href=https://github.com/guangmean/Niello target=_blank>guangmean</a>. All Rights Reserved.</div></footer></div><div class=ads></div></div><script src=/js/vendor/modernizr-3.6.0.min.js></script><script src=/js/vendor/jquery-3.3.1.min.js></script><script>window.jQuery||document.write('<script src="/js/vendor/jquery-3.3.1.min.js"><\/script>')</script><script src=/js/plugins.js></script><script src=/js/main.js></script><script src=/js/vendor/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script></body></html>